<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="patrick.unicorn" />


<title></title>




<link href="data:text/css,body%20%7B%0A%20%20%20%20font%2Dfamily%3A%20STFangSong%2C%20Helvetica%2C%20Arial%2C%20Vernada%2C%20Tahoma%2C%20STXihei%2C%20%22Microsoft%20YaHei%22%2C%20%22Songti%20SC%22%2C%20SimSun%2C%20Heiti%2C%20sans%2Dserif%3B%0A%20%20%20%20font%2Dsize%3A%2018px%3B%0A%20%20%20%20margin%3A%205%25%2020%25%205%25%2020%25%3B%0A%20%20%20%20padding%3A%202%25%205%25%205%25%205%25%3B%0A%20%20%20%20width%3A%2050%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20border%3A%201px%20solid%20LightGrey%3B%0A%7D%0A%0AH1%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%7D%0A%0AH2%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%20%20%20%20margin%2Dbottom%3A%2060px%3B%0A%20%20%20%20margin%2Dbottom%3A%2040px%3B%0A%20%20%20%20padding%3A%205px%3B%0A%20%20%20%20border%2Dbottom%3A%202px%20LightGrey%20solid%3B%0A%20%20%20%20width%3A%2098%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20color%3A%20%23666666%3B%0A%7D%0A%0A%0AH3%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%20%20%20%20margin%2Dtop%3A%2040px%3B%0A%20%20%20%20margin%2Dbottom%3A%2030px%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20LightGrey%20solid%3B%0A%20%20%20%20width%3A%2098%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20color%3A%20%23666666%3B%0A%7D%0A%0A%0AH4%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%20%20%20%20margin%2Dtop%3A%2040px%3B%0A%20%20%20%20margin%2Dbottom%3A%2030px%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20LightGrey%20solid%3B%0A%20%20%20%20width%3A%2098%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20color%3A%20%23666666%3B%0A%7D%0A%0Aul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2010px%3B%0A%7D%0A%0Ali%20%7B%0A%20%20%20%20margin%2Dleft%3A%2010px%3B%0A%7D%0A%0Aq%20%7B%0A%20%20%20%20border%2Dleft%3A%204px%20lightgrey%20solid%3B%0A%20%20%20%20padding%2Dleft%3A%205px%3B%0A%20%20%20%20margin%2Dleft%3A%2020px%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Inconsolata%2C%20Consolas%2C%20%22DEJA%20VU%20SANS%20MONO%22%2C%20%22DROID%20SANS%20MONO%22%2C%20Proggy%2C%20monospace%3B%0A%20%20%20%20font%2Dsize%3A%2090%25%3B%0A%20%20%20%20border%3A%20dashed%201px%20lightgrey%3B%0A%20%20%20%20margin%2Dleft%3A%2010px%3B%0A%20%20%20%20margin%2Dright%3A%2010px%3B%0A%20%20%20%20padding%3A%205px%3B%0A%7D%0A%0A%2Eanswer%2Dblock%20%7B%0A%20%20%20%20word%2Dbreak%3A%20normal%3B%0A%20%20%20%20display%3A%20block%3B%0A%20%20%20%20padding%3A%200px%3B%0A%20%20%20%20margin%3A%200px%3B%0A%20%20%20%20margin%2Dleft%3A%2020px%3B%0A%20%20%20%20font%2Dsize%3A%2080%25%3B%0A%20%20%20%20word%2Dwrap%3A%20break%2Dword%3B%0A%20%20%20%20color%3A%20%23333%3B%0A%20%20%20%20background%2Dcolor%3A%20%23f5f5f5%3B%0A%20%20%20%20border%3A%201px%20solid%20%23000%3B%0A%20%20%20%20border%2Dradius%3A%206px%3B%0A%20%20%20%20overflow%3A%20auto%3B%0A%7D%0A%0A%0Apre%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Inconsolata%2C%20Consolas%2C%20%22DEJA%20VU%20SANS%20MONO%22%2C%20%22DROID%20SANS%20MONO%22%2C%20Proggy%2C%20monospace%3B%20%0A%20%20%20%20font%2Dsize%3A%2075%25%3B%20%0A%20%20%20%20border%3A%20solid%201px%20lightgrey%3B%20%0A%20%20%20%20background%2Dcolor%3A%20Ivory%3B%20%0A%20%20%20%20padding%3A%205px%3B%20%0A%20%20%20%20line%2Dheight%3A%20130%25%3B%20%0A%20%20%20%20margin%2Dleft%3A%2010px%3B%0A%20%20%20%20width%3A%2095%25%3B%0A%7D%0A%0Apre%20code%20%7B%0A%20%20%20%20font%2Dsize%3A%20100%25%20%21important%3B%20%0A%20%20%20%20border%3A%20none%20%21important%3B%20%0A%20%20%20%20background%2Dcolor%3A%20Ivory%20%21important%3B%20%0A%20%20%20%20color%3A%20%23000%20%21important%3B%0A%20%20%20%20border%2Dradius%3A%200%20%21important%3B%0A%20%20%20%20padding%3A%200%200%20%21important%3B%0A%7D%0A%0A%0Acode%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Inconsolata%2C%20Consolas%2C%20%22DEJA%20VU%20SANS%20MONO%22%2C%20%22DROID%20SANS%20MONO%22%2C%20Proggy%2C%20monospace%3B%0A%20%20%20%20font%2Dsize%3A%2090%25%3B%0A%20%20%20%20padding%3A%202px%204px%3B%0A%20%20%20%20color%3A%20%23d14%3B%0A%20%20%20%20background%2Dcolor%3A%20%23f7f7f9%3B%0A%20%20%20%20border%3A%201px%20solid%20%23e1e1e8%3B%0A%20%20%20%20border%2Dradius%3A%203px%3B%0A%7D%0A%0A%0Aa%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20none%3B%0A%20%20%20%20cursor%3A%20crosshair%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20dashed%20Red%3B%0A%20%20%20%20padding%3A%201px%3B%0A%20%20%20%20color%3A%20black%3B%0A%7D%0A%0A%0Aa%3Ahover%20%7B%0A%09background%2Dcolor%3A%20LightGrey%3B%0A%7D%0A%0A%0Aimg%20%7B%0A%20%20%20%20display%3A%20block%3B%0A%20%20%20%20box%2Dshadow%3A%200%200%2010px%20%23555%3B%0A%20%20%20%20border%2Dradius%3A%206px%3B%0A%20%20%20%20margin%2Dleft%3A%20auto%3B%0A%20%20%20%20margin%2Dright%3A%20auto%3B%0A%20%20%20%20margin%2Dtop%3A%2010px%3B%0A%20%20%20%20margin%2Dbottom%3A%2010px%3B%0A%20%20%20%20%2Dwebkit%2Dbox%2Dshadow%3A%200%200%2010px%20%23555%3B%0A%20%20%20%20height%3A%20100%25%3B%0A%20%20%09width%3A%20100%25%3B%0A%7D%0A%0A%0Ahr%20%7B%0A%20%20%20%20color%3A%20LightGrey%3B%0A%7D%0A%0Atable%2C%20th%2C%20td%20%20%7B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%20%20border%3A%20solid%201px%20black%3B%0A%7D%0A%0Ath%20%7B%0A%20%20%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0Atd%20%7B%0A%20%20%20%20padding%3A%205px%3B%0A%20%20%20%20text%2Dalign%3A%20left%3B%20%20%20%20%0A%7D%0A" rel="stylesheet" type="text/css" />

</head>

<body>





<div id="c" class="section level1">
<h1>C#碎碎念之委托</h1>
<p><strong>声明：</strong> 所写均为个人阅读所思所想，请批判阅读。</p>
<hr />
<div id="perspectives" class="section level2">
<h2>Perspectives</h2>
<ul>
<li>C/C++视角</li>
</ul>
<p>可称委托是个“类型安全的函数指针”。此处的“类型安全”是指，委托本身附带了<strong>函数签名</strong>信息。</p>
<ul>
<li>Java视角</li>
</ul>
<p>可称委托是个“单方法接口”。我一直认为委托的缺失是Java语言的重大缺陷之一，尽管可以通过单方法接口去模拟委托，但是，当你在处理GUI事件体系时，这会导致大量繁琐的工作。庆幸的是，随着Java8语言特性的扩充，已经引入了“函数式接口(functional interface)”，虽然只是个语法糖，但是于编程层面来说已经方便了不少。</p>
<ul>
<li>OOP视角</li>
</ul>
<p>可以理解为“对函数的对象化封装”。委托使得函数得以如对象一般创建、传递。</p>
<!--more-->
<ul>
<li>GOF视角</li>
</ul>
<p>如果说GOF23种模式之间的共同点可以总结为一句话：“如果问题复杂，就引入间接层”。这句话同样适用于委托(模式)，委托就相当于是客户(环境)和函数之间的间接层。</p>
<ul>
<li>函数式编程视角</li>
</ul>
<p>事实上，在初步接触Scheme的相关知识后，我发现委托几乎就是为“函数式编程”而生的，委托暗含了函数式编程的思想本质：“函数就是数据，数据也是函数”，更广泛而通用的表述是“程序即数据，数据即程序”。而当有了这样一种认识之后，我的编程世界观也会变得更加丰富多彩。这也是我个人学习Scheme的一个重要诱因：不是学习Scheme的语法或使用，而是Scheme的函数式编程世界观。</p>
</div>
<div id="delegate-and-lambda" class="section level2">
<h2>Delegate and Lambda</h2>
<p>Lambda即Lambda表达式，其所指代的是函数式编程。匿名委托和Lambda基本是等价的，只不过后者具有更简洁的形式。我认为在一定程度上，可以将Lambda理解为“语法简化的委托”。</p>
</div>
<div id="delegate-and-event" class="section level2">
<h2>Delegate and Event</h2>
<p>首先需要明确的一点是“事件不是委托，委托也不是事件”。</p>
<ul>
<li><p>事件表述“发生什么”。</p></li>
<li><p>(与事件关联的)委托表述“执行什么”。</p></li>
</ul>
<p>两者之间的关系可以表述为：<code>客户环境 --&gt; 事件(event) --&gt; 委托(--&gt; 函数)</code>，有点类似<code>客户环境 --&gt; 属性(property) --&gt; 字段</code>中属性扮演的角色。事件最重要的作用即是“封装并简化”发布/订阅模式。如果要理解“事件(event)”存在的意义，可以设想下“如果没有事件(event)会发生什么情况”：</p>
<ul>
<li>基于delegate实现发布订阅模式(无event)</li>
</ul>
<pre><code>class Publisher {

    public delegate void SomeEventHandler(object paramters);
    
    public SomeEventHandler someEvent;
    
    public void onSomeEventHappen(object paramters) {
        someEvent(paramters);
    }

}

class Subscriber {

    public void SomeEventHander1(object paramters) {
        Console.WriteLine(&quot;{0}&quot;, &quot;1&quot;);
    }
    
    public void SomeEventHander2(object paramters) {
        Console.WriteLine(&quot;{0}&quot;, &quot;2&quot;);
    }

}

class Customer {

    private Publisher p = new Publisher();
    
    private Subscriber s = new Subscriber();
    
    public static void Main() {
        Customer c = new Customer();
        
        // add SomeEventHander1
        c.p.someEvent += c.s.SomeEventHander1;
        // remove SomeEventHander1
        c.p.someEvent -= c.s.SomeEventHander1;
        c.p.someEvent += c.s.SomeEventHander1;
        
        // (1)
        // reassign the p.someEventHandler
        c.p.someEvent = c.s.SomeEventHander2; 
        // invoke the handler in outer class
        c.p.someEvent(null);
    }

}

output: 2</code></pre>
<ul>
<li>基于event实现发布订阅模式</li>
</ul>
<pre><code>class Publisher {

    public delegate void SomeEventHandler(object paramters);
    
    public event SomeEventHandler someEvent;
    
    public void onSomeEventHappen(object paramters) {
        // valid: invoke in the class that published event.
        someEvent(paramters);
    }

}

class Subscriber {

    public void SomeEventHander1(object paramters) {
        Console.WriteLine(&quot;{0}&quot;, &quot;1&quot;);
    }
    
    public void SomeEventHander2(object paramters) {
        Console.WriteLine(&quot;{0}&quot;, &quot;2&quot;);
    }

}

class Customer {

    private Publisher p = new Publisher();
    
    private Subscriber s = new Subscriber();
    
    public static void Main() {
        Customer c = new Customer();
        // add SomeEventHander1
        c.p.someEvent += c.s.SomeEventHander1;
        // remove SomeEventHander1
        c.p.someEvent -= c.s.SomeEventHander1;
        c.p.someEvent += c.s.SomeEventHander1;
        
        // (2)
        // invalid: reassign in the outer class
        c.p.someEvent = c.s.SomeEventHander2;
        // invalid: invoke in the outer class
        c.p.someEvent(null);
    }

}</code></pre>
<p>从上面的例子可以看出，两种情况的关键不同在于<code>(1)</code>和<code>(2)</code>处对<code>someEventHandler</code>操作的不同：</p>
<ul>
<li><p>在基于委托的例子中，既可以对事件处理函数<strong>增减</strong>，也可以<strong>重新赋值</strong>事件处理函数。</p></li>
<li><p>在基于事件的例子中，只能对事件处理函数<strong>增减</strong>，不能<strong>重新赋值(覆盖)</strong>原有的事件处理函数。</p></li>
</ul>
<p>也就是说event关键字相当于限制了事件处理函数的操作(<strong>在事件类外部</strong>)只能增减，不能赋值(覆盖)或调用等其他操作。</p>
</div>
<div id="usage" class="section level2">
<h2>Usage</h2>
<div id="basic" class="section level3">
<h3>Basic</h3>
<p>委托是个“函数类类型”。与int用于定义整型类似，delegate用于定义<strong>某种类型函数的类型</strong>。</p>
<pre><code>class Demo {
    // 定义委托类型
    public delegate void Processor(string param);
    
    public static void ProcessBill(string orderNo) {
        ...
    }
    
    // 定义委托对象
    Processor processor0 = new Processor(Demo.ProcessBill);
    Processor processor1 = Demo.ProcessBill;
}</code></pre>
<p>注：在实际的使用中，并不严格要求委托实例和委托类型的函数签名完全一致(逆变与协变)，具体可以参看C#相关文档。</p>
</div>
<div id="method-chain" class="section level3">
<h3>Method Chain</h3>
<p>委托实例可以引用一组方法。如下：</p>
<pre><code>class Demo {
    // 定义委托类型
    public delegate void Processor(string param);
    
    public static void ProcessBill(string orderNo) {
        ...
    }
    
    public static void ProcessDistribution(string orderNo) {
        ...
    }
    
    // 定义委托对象
    Processor processor += Demo.ProcessBill;
    processor += Demo.ProcessDistribution;
}</code></pre>
<p>几点注意：</p>
<ul>
<li><p>只有最后一个有返回值的函数的返回值可以被返回，其他函数的返回值会直接忽略。</p></li>
<li><p>如果某个函数调用出现异常，则委托链之后的函数均<strong>不会调用</strong>。</p></li>
</ul>
<p>其实委托的这一链式特性，就是GOF中职责链模式的一种简化形式。</p>
</div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
