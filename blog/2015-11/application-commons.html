<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="patrick.unicorn" />


<title></title>




<link href="data:text/css,body%20%7B%0A%20%20%20%20font%2Dfamily%3A%20STFangSong%2C%20Helvetica%2C%20Arial%2C%20Vernada%2C%20Tahoma%2C%20STXihei%2C%20%22Microsoft%20YaHei%22%2C%20%22Songti%20SC%22%2C%20SimSun%2C%20Heiti%2C%20sans%2Dserif%3B%0A%20%20%20%20font%2Dsize%3A%2018px%3B%0A%20%20%20%20margin%3A%205%25%2020%25%205%25%2020%25%3B%0A%20%20%20%20padding%3A%202%25%205%25%205%25%205%25%3B%0A%20%20%20%20width%3A%2050%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20border%3A%201px%20solid%20LightGrey%3B%0A%7D%0A%0AH1%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%7D%0A%0AH2%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%20%20%20%20margin%2Dbottom%3A%2060px%3B%0A%20%20%20%20margin%2Dbottom%3A%2040px%3B%0A%20%20%20%20padding%3A%205px%3B%0A%20%20%20%20border%2Dbottom%3A%202px%20LightGrey%20solid%3B%0A%20%20%20%20width%3A%2098%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20color%3A%20%23666666%3B%0A%7D%0A%0A%0AH3%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%20%20%20%20margin%2Dtop%3A%2040px%3B%0A%20%20%20%20margin%2Dbottom%3A%2030px%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20LightGrey%20solid%3B%0A%20%20%20%20width%3A%2098%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20color%3A%20%23666666%3B%0A%7D%0A%0A%0AH4%20%7B%0A%20%20%20%20font%2Dfamily%3A%20%22Palatino%20Linotype%22%2C%20%22Book%20Antiqua%22%2C%20Palatino%2C%20Helvetica%2C%20STKaiti%2C%20SimSun%2C%20serif%3B%0A%20%20%20%20margin%2Dtop%3A%2040px%3B%0A%20%20%20%20margin%2Dbottom%3A%2030px%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20LightGrey%20solid%3B%0A%20%20%20%20width%3A%2098%25%3B%0A%20%20%20%20line%2Dheight%3A%20150%25%3B%0A%20%20%20%20color%3A%20%23666666%3B%0A%7D%0A%0Aul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2010px%3B%0A%7D%0A%0Ali%20%7B%0A%20%20%20%20margin%2Dleft%3A%2010px%3B%0A%7D%0A%0Aq%20%7B%0A%20%20%20%20border%2Dleft%3A%204px%20lightgrey%20solid%3B%0A%20%20%20%20padding%2Dleft%3A%205px%3B%0A%20%20%20%20margin%2Dleft%3A%2020px%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Inconsolata%2C%20Consolas%2C%20%22DEJA%20VU%20SANS%20MONO%22%2C%20%22DROID%20SANS%20MONO%22%2C%20Proggy%2C%20monospace%3B%0A%20%20%20%20font%2Dsize%3A%2090%25%3B%0A%20%20%20%20border%3A%20dashed%201px%20lightgrey%3B%0A%20%20%20%20margin%2Dleft%3A%2010px%3B%0A%20%20%20%20margin%2Dright%3A%2010px%3B%0A%20%20%20%20padding%3A%205px%3B%0A%7D%0A%0A%2Eanswer%2Dblock%20%7B%0A%20%20%20%20word%2Dbreak%3A%20normal%3B%0A%20%20%20%20display%3A%20block%3B%0A%20%20%20%20padding%3A%200px%3B%0A%20%20%20%20margin%3A%200px%3B%0A%20%20%20%20margin%2Dleft%3A%2020px%3B%0A%20%20%20%20font%2Dsize%3A%2080%25%3B%0A%20%20%20%20word%2Dwrap%3A%20break%2Dword%3B%0A%20%20%20%20color%3A%20%23333%3B%0A%20%20%20%20background%2Dcolor%3A%20%23f5f5f5%3B%0A%20%20%20%20border%3A%201px%20solid%20%23000%3B%0A%20%20%20%20border%2Dradius%3A%206px%3B%0A%20%20%20%20overflow%3A%20auto%3B%0A%7D%0A%0A%0Apre%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Inconsolata%2C%20Consolas%2C%20%22DEJA%20VU%20SANS%20MONO%22%2C%20%22DROID%20SANS%20MONO%22%2C%20Proggy%2C%20monospace%3B%20%0A%20%20%20%20font%2Dsize%3A%2075%25%3B%20%0A%20%20%20%20border%3A%20solid%201px%20lightgrey%3B%20%0A%20%20%20%20background%2Dcolor%3A%20Ivory%3B%20%0A%20%20%20%20padding%3A%205px%3B%20%0A%20%20%20%20line%2Dheight%3A%20130%25%3B%20%0A%20%20%20%20margin%2Dleft%3A%2010px%3B%0A%20%20%20%20width%3A%2095%25%3B%0A%7D%0A%0Apre%20code%20%7B%0A%20%20%20%20font%2Dsize%3A%20100%25%20%21important%3B%20%0A%20%20%20%20border%3A%20none%20%21important%3B%20%0A%20%20%20%20background%2Dcolor%3A%20Ivory%20%21important%3B%20%0A%20%20%20%20color%3A%20%23000%20%21important%3B%0A%20%20%20%20border%2Dradius%3A%200%20%21important%3B%0A%20%20%20%20padding%3A%200%200%20%21important%3B%0A%7D%0A%0A%0Acode%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Inconsolata%2C%20Consolas%2C%20%22DEJA%20VU%20SANS%20MONO%22%2C%20%22DROID%20SANS%20MONO%22%2C%20Proggy%2C%20monospace%3B%0A%20%20%20%20font%2Dsize%3A%2090%25%3B%0A%20%20%20%20padding%3A%202px%204px%3B%0A%20%20%20%20color%3A%20%23d14%3B%0A%20%20%20%20background%2Dcolor%3A%20%23f7f7f9%3B%0A%20%20%20%20border%3A%201px%20solid%20%23e1e1e8%3B%0A%20%20%20%20border%2Dradius%3A%203px%3B%0A%7D%0A%0A%0Aa%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20none%3B%0A%20%20%20%20cursor%3A%20crosshair%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20dashed%20Red%3B%0A%20%20%20%20padding%3A%201px%3B%0A%20%20%20%20color%3A%20black%3B%0A%7D%0A%0A%0Aa%3Ahover%20%7B%0A%09background%2Dcolor%3A%20LightGrey%3B%0A%7D%0A%0A%0Aimg%20%7B%0A%20%20%20%20display%3A%20block%3B%0A%20%20%20%20box%2Dshadow%3A%200%200%2010px%20%23555%3B%0A%20%20%20%20border%2Dradius%3A%206px%3B%0A%20%20%20%20margin%2Dleft%3A%20auto%3B%0A%20%20%20%20margin%2Dright%3A%20auto%3B%0A%20%20%20%20margin%2Dtop%3A%2010px%3B%0A%20%20%20%20margin%2Dbottom%3A%2010px%3B%0A%20%20%20%20%2Dwebkit%2Dbox%2Dshadow%3A%200%200%2010px%20%23555%3B%0A%20%20%20%20height%3A%20100%25%3B%0A%20%20%09width%3A%20100%25%3B%0A%7D%0A%0A%0Ahr%20%7B%0A%20%20%20%20color%3A%20LightGrey%3B%0A%7D%0A%0Atable%2C%20th%2C%20td%20%20%7B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%20%20border%3A%20solid%201px%20black%3B%0A%7D%0A%0Ath%20%7B%0A%20%20%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0Atd%20%7B%0A%20%20%20%20padding%3A%205px%3B%0A%20%20%20%20text%2Dalign%3A%20left%3B%20%20%20%20%0A%7D%0A" rel="stylesheet" type="text/css" />

</head>

<body>





<div class="section level1">
<h1>系统构建的若干通用方面</h1>
<p>这几年做项目的过程中，杂七杂八的记录在wiki中的东东，没啥调理，罗列整理一下。</p>
<hr />
<ul>
<li><p>性能问题归根到底是数据结构和算法问题。不同的是，有些情况我们只需要理解（如数据库的索引结构和数据算法，JVM GC算法）并合理使用，而有些情况，需要我们手动实现。</p></li>
<li><p>API实现的时候，如果某些API需要权限认证，并在接口内使用认证信息，那么，最好不要将该认证信息作为API的参数绑定（最典型的做法就是Spring Controller的自动绑定），因为，这样会导致接口定义“侵入”，同时对于API文档的生成也不友好；另外，如果使用swagger之类的api框架，则会带来兼容问题。</p></li>
<li><p>需求调研的核心是“考察人的需求”，因此，应当“以人为中心”，引导被调查者说出自身的需求。</p></li>
<li><p>一定要重视开发期测试的方便性。比如，必须可以配置权限的开关。免得开发期每个人验证问题时必须做繁琐的登录验证。还有就是部署时期的不同的profile的设定。</p></li>
<li><p>必须重视测试工作。测试人员必须具备基本开发工具的使用，尤其是数据库和SQL的使用。同时必须深入理解业务，否则会测出很多并不是bug的Bug，降低时间利用效率。</p></li>
<li><p>如果客户端可能是多种设备，优先考虑“API-First”架构，其设计细节可参看《RESTful API 设计指南》以及www.apigee.com</p></li>
<li><p>手机软件中必须确定对应的机型（操作系统和屏幕像素），提供的PSD图如果只有一份，必须说明在不同机型上组装之后，可能出现像素偏移等。调整透明度与屏幕截图进行对比，可以准备比对像素偏移。</p></li>
<li><p>对于后台管理类的系统，必须对所有的操作（尤其是更新数据类操作）进行日志记录，以此保证（管理类）操作人员的操作履历可以被审查。</p></li>
<li><p>对于日志较多的系统（游戏服务器，电子商务等），必须对日志进行详细的规划，并统一存储处理，这方面的框架现在也比较多，比如流行的开源组合ELK等等。</p></li>
<li><p>对于某些应用的数据而言，在数据上标记并加入版本号记录（客户端版本，服务端版本）是一种比较好的实践，比如游戏应用。</p></li>
<li><p>数据层优化就三个方面：1. SQL语句本身的优化（少用distinct，优先连接） 2. 索引（唯一索引，普通索引，聚合索引） 3. 调整DB的配置参数（如查询缓存大小等）</p></li>
<li><p>当程序BUG导致线上数据一致性出现问题时，通常需要写专门的修复程序。程序本身最好不要去直接修改线上数据库的数据，而是采用使用程序生成SQL的方式，去修改。这样好处多多。</p></li>
<li><p>系统性能优化的三个层面：1. 业务代码优化（少用锁，FindBug，StringBuilder连接，采用合适的数据结构（算法），使用performance监控工具监控JVM，如阿里巴巴的Tprofiler） 2. 数据层优化 3. 架构优化（数据层- 缓存，如NOSQL，Memcache的应用；读写分离；数据库sharding/patitioning【分片/分区】；应用层-分布式，静态化（WEB），数据封包（TCP/UDP层面就是定义每个包的最大程度如4K，HTTP层面就是大请求分割为多个小请求，一个目的：减少I/O阻塞），异步化（队列、协程、多线程，一个目的：降低操作系统内核态和用户态的切换。）</p></li>
<li><p>软件（架构）设计从头到尾就一个目标：分解复杂度（解耦业务复杂度，人员复杂度）。各种编程范式OOP，AOP，OFP，各种设计模式，各类架构模式，都是在解决复杂性，如果找不到合适的方式降低复杂度，就”增加一个间接层“。人员复杂度以业务复杂度解耦为基础，使每个开发者的专注域正交化，最小化。</p></li>
<li><p>在发布预发布版之后，必须定期检测mysql的慢查询。</p></li>
<li><p>正式环境中DB必须禁止任何危险的DDL（如输出库），Delete（没有Where），并定时备份数据库，给出的连接用户不能具有Root权限的用户。</p></li>
<li><p>對於有UI畫面的應用程序開發，必須在項目中穿插UI設計人員的UI審核流程，確認頁面元素的顯示效果。不能只依賴於開發人員的確認。</p></li>
<li><p>用户ID绝对不能从客户端参数中获取，必须从当前session中获取，否则，极有可能被恶意攻击者修改其他客户的用户信息。与用户ID相关联的资源ID可以从客户端参数中获取，但是必须进行用户ID的再次验证，比如对于一个电子商务网站，订单ID可以从参数中获取，但是，服务端必须验证当前用户是订单的可操作者。</p></li>
<li><p>用户密码绝对不能保存明文</p></li>
<li><p>对于某些资源的操作，必须确认该资源是正常资源，比如用户背景图片的修改，那么就必须保证该图片是服务器中存在的图片，否则，认为是恶意请求。</p></li>
<li><p>移動應用需要明確對應的機型。本地應用還是WEBView應用。</p></li>
<li><p>URL的规则，因为涉及到SEO，网站地图等，需要及早确认。</p></li>
<li><p>兼容性需求，比如：WEB项目需要支持的浏览器，纯客户端软件需要支持的OS（Android，IOS，PC，Mac，Linux）</p></li>
<li><p>是否需要集成第三方的系统，如社交系统（Facebook，Google+，Twitter等等）</p></li>
<li><p>日志记录的策略： 记录形式（DB， TXT， MAIL） 日志分类（异常日志， 操作日志， 业务日志）。</p></li>
<li><p>系统中的组织机构、权限机构和策略。 权限层级一定不能超过三层，否则维护成本会非常高。可以参考通用的权限设计组件</p></li>
<li><p>系统中异常发生时的展示策略（AJAX NON-AJAX）</p></li>
<li><p>AJAX的跨域解决方案参考《JavaScript跨域总结与解决办法》</p></li>
<li><p>系统中资源的锁定（订单，合同）</p></li>
<li><p>数据DB中的主键尽量不要使用有业务意义的列，因为，业务的变化性很大，原来唯一的东西，可能后来不唯一，从而导致DB结构剧烈变化。</p></li>
<li><p>系统中的DB事务策略（分析哪些业务场景需要使用使用事务）</p></li>
</ul>
<p>ORM Entity对象与业务对象的互相转换， 可以考虑采用成熟的。框架，如Dozer（<a href="http://dozer.sourceforge.net/），">http://dozer.sourceforge.net/），</a> 当业务情况比较复杂，应用领域对象设计系统时， 由于领域对象与DB Entity的矛盾， 存在大量的对象复制操作，所以使用此类框架能节省很多功夫。</p>
<ul>
<li><p>在系统第一次正式版本发布（测试服务器）后的时间内，需要每天查看服务器的日志记录，处理其中的异常情况。因为是日常工作，所以，在测试阶段至少应该将服务器（选取几个）中每天发生的错误以邮件的形式发送到开发人员邮箱，提高效率。</p></li>
<li><p>对于Web项目， 并发量和负载量等非功能性需求，需要尽早确认，以准备好相应的软硬件设施。实际上线前必须进行并发测试。</p></li>
<li><p>如果需要负载均衡，那么关于负载策略（DNS，Apache ，Ngix，HA），session共享等相关问题需要进行提前沟通。</p></li>
<li><p>凡是ajax异步方法均以统一前缀开始，如asyncXXX</p></li>
<li><p>分页功能对于每个系统基本都是必需的组件，分页具体的策略也需要和客户沟通，只是单页排序，还是跨页排序，如果是跨页排序，需要在服务端进行全表排序查询，以下为常见分页SQL：</p></li>
</ul>
<pre><code>- MySQL：

SELECT * FROM TABLE1 
WHERE [......] 
ORDER BY [......] LIMIT [low-index], [up-index]

- Oracle： 

SELECT * FROM (
    SELECT A.*, ROWNUM RN 
    FROM (
            SELECT * 
            FROM TABLE1 
            WHERE [.....] 
            ORDER BY GMT_CREATE DESC
        ) A
    ) 
WHERE RN BETWEEN [low-index] AND [up-index];

- MSServer：

SELECT * 
FROM (
        SELECT ROW_NUMBER() OVER (ORDER BY [....]) rownum, * 
        FROM TABLE1
     ) a 
WHERE rownum &gt; [low-index] AND rownum &lt; [up-index]
    </code></pre>
<ul>
<li><p>对于大量使用JS的项目来说， 以下方面都需要考虑： 是否采用JS框架（Knockout.js Angular.js等等）, 如何防止Ajax重复提交， Ajax数据是否加密或压缩， Ajax服务端响应异常处理， Ajax请求超时处理， 页面输入元素编辑和非编辑状态切换（Editable）， Table客户端分页排序与服务端的结合（TableSorter.js）, 页面日期输入和格式化， 页面金额输入和验证（分隔符。及形式）， 各种输入框的验证（validate.js）， 。是否采用统一的窗口弹出（lhgdialog.js）, 采用何种文件上传框架（plupload.js）， JSON框架采用JSON2， 考虑采用浏览器本地存储（<a href="http://www.jstorage.info/）">http://www.jstorage.info/）</a></p></li>
<li><p>当前登录用户的登出方式： 主动和被动。 被动方式通常包含：Session超时， 被管理员强制下线， 重置密码后被强制下线。 各种登出方式下， 如果进行提示和重新登陆？</p></li>
<li><p>对于有多个子系统的集成性系统， 需要尽早确认URL组成规则，以及重定向规则。同时需要考虑是否需要单点登录。</p></li>
<li><p>列表的分页以及排序。</p></li>
</ul>
<p>对于从查询页面A跳转到其他页面B。时， 如果B页面有返回按钮， 则需要考虑如果实现返回后， 恢复A页面之前的查询条件中的已填入值。该问题引出另外一个问题： 页面的查询参数如何在页面之间传输，最好的方式是直接采用URL + 参数， google， 百度等均采用。</p>
<p>必须确定系统中不同数据采用的删除方式（物理删除和逻辑删除）。 通常，对于财务， 账单， 用户， 操作记录， 已经系统的核心数据等等采用逻辑删除。 通常一个系统的核心数据， 在程序层面体现在其核心领域对象上， 比如： 电子商务系统核心对象是商品订单， 航空订票系统核心对象是机票订单， 财务系统核心对象是账单， 企业公文流转系统核心对象是公文等等， 如上的核心对象数据在各自的系统中都应该采用逻辑删除， 而非物理删除。</p>
<ul>
<li>一个（非集成性）系统中的核心对象通常只有一个， 对于该核心领域对象的增删改查需要特别的关注， 因为核心对象的外延对象（也指关联对象）通常都非常多， 进而带来了增删改时的事务处理， 以及查询时的多表查询。</li>
</ul>
<p>数据库主键生成策略的选择。主键生成函数如果存在重复概率，那么必须在相关资源插入的时候，将主键生成和数据保存做同步处理， 保证两者在一个同步块中，否则在多并发多线程时会产生数据库主键插入冲突；如果主键生成随机无重复， 则不必要。</p>
<p>无论对于Formt提交还是Ajax提交而言， 都存在重复提交的问题。 form提交可以采用struts等框架自带的token机制。 而对于ajax提交有两种主要的方式： 一种是发送请求前，设置button为disabled， 要求必须是button触发； 另外一种是采用ajax同步提交， 具体有jquery的async设置等等。</p>
<ul>
<li>对于系统业务数据的保存/删除/更新， 如果使用ajax， 通常都应该采用同步提交方式，而非异步。 因为异步容易在数据提交异常的情况下， 给客户“数据已经提交”的错觉。</li>
</ul>
<p>对于一个系统而言， 一些核心业务数据的“来源”在通常需要区分， 这样便于记录查询数据问题。 比如：对于平台型电商系统（比如淘宝。），订单的来源有可能是（1）本平台预定 。（2）订单开放API预定。再比如：对于契约系统而言，契约数据可能来源于：（1）从外部通过Excel/CSV导入 （2）通过系统页面创建提交</p>
<p>对于系统中的核心操作数据的增删改操作， 必须。记录所有的输入输出， 尤其删除时， 需要记录整个信息实体，而非通常的主键值， 比如： 电子商务系统中订单的操作， 物流系统中订单的操作， 航空系统中航程单的操作， 。金融系统中账户操作， 账单系统中账单的操作。</p>
<p>系统主键生成策略主要分两种形式： a. 无序组合（完全随机数生成，如GUID）； b. 完全有序组合（如自增键， 毫秒数等）； C. 无序组合 + 有序组合（如主键=单位I。D+自增字段值）。三种情况各有长短处， 。通常对于业务型数据（如订单， 公文），采用 c的方式比较普遍， 原因是希望通过主键（订单号， 公文号）能尽可能的确立较多的信息（如 所属单位， 发布时间等等）</p>
<ul>
<li><p>如果自建业务对象主键机制，非常重要的一点是，必须针对系统主键进行并发测试，保证唯一性。在DB设计中最好是统一使用id来命名主键字段。</p></li>
<li><p>对于系统业务相关数据表， 创建时间， 更新时间， 创建人， 更新人四个字段通常情况下， 都必须设计。</p></li>
<li><p>系统中的主键生成方式最好不要超过两种。</p></li>
<li><p>DB设计中不要使用外键， 由程序保持一致性。在创建数据时， 更新时间不要填入创建时间， 要保存为空。</p></li>
<li><p>团队中的每个人， 包括构建服务器， 测试服务器， 本地开发电脑， 正式线上服务器，必须使用同样的工具， 即使是编译器，也可能在存在bug，导致编译后的代码有问题。</p></li>
<li><p>系统中并不是所有的bug都需要解决， 比如那些因为网络， 硬件等外力因素导致的bug， 需要进行甄别。</p></li>
<li><p>DTO与Entity对象的区别在于， 两者的映射对象不一样， 前者映射于展现数据，Entity映射与DB数据，但是两者通常来说都存在部分重合， 因此某些情况下（比如系统小而简单）， 可以直接用Entity作为DTO，而不必重新单独声明对应的DTO。产生这种差异的原因在于： 在关系DB层面，要尽量遵守数据库设计规约，减少不同数据表之间的数据冗余，否则，在进行数据更新时， 因为同样的数据冗余在多个表中， 会产生更新多张表。关于多个对象之间的映射可以使用成熟的映射框架，如Dozer。</p></li>
<li><p>表单（POST）重复提交问题。原因：点击提交按钮两次/点击刷新按钮/使用浏览器后退按钮重复之前的操作，导致重复提交表单/使用浏览器历史记录重复提交表单/浏览器重复的HTTP请求。防止策略： 》禁用（disabled）提交按钮。缺点是，如果脚本被禁用，就无效了。 》Post/Redirect/Get模式，提交后执行页面重定向到其他页面（如登录后到首页等），能避免用户按F5导致的重复提交，而其也不会出现浏览器表单重复提交的警告，也能消除按浏览器前进和后退按导致的同样问题。 》</p></li>
<li><p>XSS防御方式：</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>允许输入 ，直接按原文（输入）存储进数据库，展示的时候，进行转义，如<code>&lt;script&gt;</code> 转义为 &amp;#60script&amp;#62， 那么浏览器展现时直接以文本方式展示为<code>&lt;script&gt;</code>，而不进行“解释”。具体显示时，JSP可以使用fn:escapeXml，js可以采用对应的Js库（如：mhandbook项目的xss-filter)。</p></li>
<li><p>不允许输入，在JS和后端进行字符判定，如添加Filter对所有的Request参数（form和Get）进行判定，出现敏感字符（可定义黑名单）即可抛出异常。此处不可以转义存储，因为，转义后可能超出数据库相应字段的最大长度限制，导致SQL异常。</p></li>
</ol>
<p>方式一更加可取，对用户也更加友好。</p>
<p>一些成熟Server端解决方案：</p>
<blockquote>
<ul>
<li>Spring Security(defaultHtmlEscape）</li>
<li>OWASP Enterprise Security API</li>
<li><a href="http://en.wikipedia.org/wiki/Cross-site_scripting">Cross-site_scripting</a></li>
<li>JSTL JSP <fn:escapeXml>标签</li>
<li><a href="https://github.com/coverity/coverity-security-library">coverity-security-library</a></li>
<li><p>apache-commons中的</p>
<p>StringEscapeUtils.escapeHtml(string); StringEscapeUtils.escapeJavaScript(string); StringEscapeUtils.escapeSql(string);</p></li>
<li>自建
</blockquote>
</li>
</ul>
<p>一些成熟前端解决方案：</p>
<blockquote>
 
<ul>
<li>OWASP Enterprise Security Javascript API</li>
<li>XSS Validator (Node.js)
</blockquote>
</li>
<li>CSRF防御，必须先保证先防御XSS（相对而言，XSS更难防御），数据改变操作必须用POST，防御三种方式：</li>
</ul>
<ol style="list-style-type: decimal">
<li><p>Referer判断：可以伪造，所以并不安全。</p></li>
<li><p>验证码：用户体验差。</p></li>
<li><p>Token：最可靠。但大型服务时，需要一台token生成及校验服务器；需要更改所有表单添加字段。中小型服务还是足够了。原理：无法通过ajax等方式获得外域页面中的 token值，xmlhttprequest需要遵守浏览器同源策略。</p></li>
</ol>
<p>一些成熟解决方案：</p>
<blockquote>
<ul>
<li>Spring Security(包含AJAX 防御）</li>
<li><a href="http://ricardozuasti.com/2012/preventing-csrf-in-java-web-apps/">csrf</a></li>
<li>使用<a href="http://www.jtmelton.com/2010/05/16/the-owasp-top-ten-and-esapi-part-6-cross-site-request-forgery-csrf/">OWASP ESAPI</a> 实现
</blockquote>
</li>
<li><p>禁止网站被恶意反向代理（Ifram嵌入）：</p>
<ol style="list-style-type: decimal">
<li><p>客户端脚本： if (top.location != self.location) { top.location=self.location; } 缺点：对搜索引擎不友好。</p></li>
<li><p>服务端设置： Apache和Ngix有对应的设置。</p></li>
</ol></li>
<li><p>Referer是可以被客户单伪造的（如某些浏览器插件），因此，不能够将Referer用在一些非常关键的检查上。Referer两个最常用的用途：</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>防盗链 ：在WEB服务器（Apache/Ngix）可以设置某些资源（图片）只能被本域名访问</p></li>
<li><p>访问统计：统计每一个页面都是从哪些入口页面过来的</p></li>
</ol>
<ul>
<li><p>用户登录过程应该使用HTTPS，而非HTTP。其他的关键Form请求，如支付等等，也必须使用HTTPS。</p></li>
<li><p>应用必须做压力测试（Jmeter/AB/等等），同时也必须做安全性测试（NetSparker）</p></li>
<li><p>压力测试。需要选择工具，构建用例，同时在架构程序时必须对某些功能做配置化（开关）以方便压力测试，如IP限制，cookie，csrf等等。</p></li>
<li><p>日志文件的分布式处理，可以利用成熟产品如Facebook的Scribe等等，具体参看《开源日志系统》。</p></li>
<li><p>软件开发中的金额（此处包含游戏中的需要购买的某种“虚拟货币“，如Q币，宝石等等）的变化更新时，需要进行数据库的增量更新（即在原来的DB值上加增量）而非直接覆盖原有的值，同时，必须对传过来的变化量进行验证（比如，对于游戏而言，某个等级物品的卖出只能增加8个宝石，那么应该与Master数据表进行核对）。对于游戏服务二样，另外一种方法是，凡是关于”货币“的计算，都由服务端通过master数据进行计算，而非新人客户端的值。</p></li>
<li><p>网站的访问日志（footmark），尤其是移动互联网项目。可以利用ELK进行完整的分析和展现。</p></li>
</ul>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
